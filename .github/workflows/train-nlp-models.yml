name: Deploy NLP Service

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]
    paths: [ 'fliptracker/apps/nlp-service/**' ]

jobs:
  train:
    name: üß† Train NER Model
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: fliptracker/apps/nlp-service
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Training Deps
        run: pip install spacy

      - name: Prepare & Train
        run: |
          # 1. Conversion des donn√©es
          python -c "
          import spacy, json, os
          from spacy.tokens import DocBin
          nlp = spacy.blank('fr')
          db = DocBin()
          with open('aa.jsonl.json', 'r', encoding='utf-8') as f:
              data = json.load(f)
          for item in data:
              text = item['text'] if 'text' in item else json.loads(item['line']).get('text', '')
              if not text: continue
              doc = nlp.make_doc(text)
              ents = []
              for e in item.get('entities', []):
                  span = doc.char_span(e['start'], e['end'], label=e['entity'], alignment_mode='contract')
                  if span: ents.append(span)
              doc.ents = ents
              db.add(doc)
          db.to_disk('train.spacy')
          "
          # 2. Config & Training
          python -m spacy init config config.cfg --lang fr --pipeline ner --optimize efficiency --force
          python -m spacy train config.cfg --output ./output --paths.train ./train.spacy --paths.dev ./train.spacy

      - name: Save Model
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: fliptracker/apps/nlp-service/output/model-best

  build:
    name: üê≥ Build & Push Docker
    needs: train
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Download Model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: fliptracker/apps/nlp-service/model-best
      
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: fliptracker/apps/nlp-service
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/fliptracker-nlp:latest