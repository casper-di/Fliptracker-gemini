name: Deploy NLP Service

on:
  workflow_dispatch: {}
  push:
    branches:
      - main
    paths:
      - 'fliptracker/apps/nlp-service/**'

jobs:
  train:
    name: Train Lightweight NER
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install spacy

      - name: Prepare Training Data
        working-directory: fliptracker/apps/nlp-service
        run: |
          python -c "
          import spacy, json, os
          from spacy.tokens import DocBin

          def convert():
              nlp = spacy.blank('fr')
              db = DocBin()
              
              # Charger les donn√©es r√©elles (aa.jsonl.json)
              with open('aa.jsonl.json', 'r') as f:
                  real_data = json.load(f)
              
              # Charger les donn√©es synth√©tiques (les 50 adresses)
              with open('synthetic_data.json', 'r') as f:
                  synth_data = json.load(f)

              # Traitement aa.jsonl.json (format sp√©cifique avec 'line')
              for item in real_data:
                  try:
                      line_content = json.loads(item['line'])
                      text = line_content.get('text') or line_content.get('subject') or ''
                      if not text: continue
                      
                      doc = nlp.make_doc(text)
                      ents = []
                      for ent in item['entities']:
                          span = doc.char_span(ent['start'], ent['end'], label=ent['entity'], alignment_mode='contract')
                          if span: ents.append(span)
                      doc.ents = ents
                      db.add(doc)
                  except: continue

              # Traitement synthetic_data.json
              for item in synth_data:
                  doc = nlp.make_doc(item['text'])
                  ents = []
                  for ent in item['entities']:
                      span = doc.char_span(ent['start'], ent['end'], label=ent['entity'], alignment_mode='contract')
                      if span: ents.append(span)
                  doc.ents = ents
                  db.add(doc)
              
              db.to_disk('train.spacy')

          convert()
          "

      - name: Train Model
        working-directory: fliptracker/apps/nlp-service
        run: |
          python -m spacy init config config.cfg --lang fr --pipeline ner --optimize efficiency --force
          python -m spacy train config.cfg --output ./output --paths.train ./train.spacy --paths.dev ./train.spacy

      - name: Upload Model Artifact
        uses: actions/upload-artifact@v4
        with:
          name: trained-model
          path: fliptracker/apps/nlp-service/output/model-best

  test:
    name: Test NLP Service
    runs-on: ubuntu-latest
    needs: train
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: fliptracker/apps/nlp-service/model-best

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r fliptracker/apps/nlp-service/requirements.txt

      - name: Test extractor
        working-directory: fliptracker/apps/nlp-service
        run: |
          python -c "
          import spacy
          try:
              nlp = spacy.load('model-best')
              doc = nlp('Votre colis est arriv√© √† Monoprix, 90 Grande Rue, 69600 Oullins')
              print('--- Entities Found ---')
              for ent in doc.ents:
                  print(f'{ent.label_}: {ent.text}')
              print('--- Test Success ---')
          except Exception as e:
              print(f'Test failed: {e}')
              exit(1)
          "

  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Model
        uses: actions/download-artifact@v4
        with:
          name: trained-model
          path: fliptracker/apps/nlp-service/model-best

      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          context: fliptracker/apps/nlp-service
          file: fliptracker/apps/nlp-service/Dockerfile
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/fliptracker-nlp:latest

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: build
    if: always()
    steps:
      - name: Show results
        run: echo "üéâ Le mod√®le est pr√™t dans Docker et disponible en t√©l√©chargement dans les Artifacts GitHub."